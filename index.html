<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { text-align:center; font-family:sans-serif; background:#f0f0f0; }
  #gacha { margin-top:30px; }
  #gacha img { width:150px; transition: transform 0.5s; }
  #prize { display:none; position:relative; margin-top:20px; }
  #prize img { width:200px; }
  #prize .close { position:absolute; top:5px; right:5px; cursor:pointer; font-size:20px; }
  #status { margin-top:10px; font-weight:bold; }
  button { padding:10px 20px; margin-top:10px; font-size:16px; cursor:pointer; }
  input { padding:10px; font-size:16px; width:120px; text-align:center; }
</style>
</head>
<body>

<h1>線上扭蛋抽獎</h1>

<!-- 驗證碼輸入頁 -->
<div id="verify">
  <input type="text" id="codeInput" placeholder="輸入4位驗證碼"/>
  <button onclick="verifyCode()">確認</button>
</div>

<!-- 抽獎頁 -->
<div id="gacha" style="display:none;">
  <div id="status">已抽：0 / 剩餘：60</div>
  <img id="gachaEgg" src="gacha.png" alt="扭蛋">
  <br>
  <button onclick="drawPrize()">抽獎</button>
</div>

<!-- 獎項頁 -->
<div id="prize">
  <div class="close" onclick="backToGacha()">✖</div>
  <h2>恭喜抽到：</h2>
  <img id="prizeImg" src="" alt="獎項">
  <h3 id="prizeName"></h3>
</div>

<script>
let currentCode = '';
let prizeImages = {
  A: 'A.png', // 替換成真實圖片路徑
  B: 'B.png',
  C: 'C.png',
  D: 'D.png'
};

// 更新剩餘抽數
function updateStatus(){
  fetch('https://nny-08.github.io:3000/status')
  .then(res=>res.json())
  .then(data=>{
    document.getElementById('status').innerText = `已抽：${data.drawn} / 剩餘：${data.remaining}`;
  });
}

// 驗證碼確認
function verifyCode(){
  const code = document.getElementById('codeInput').value;
  if(code.length !== 4){ alert('請輸入4位驗證碼'); return; }
  fetch('https://nny-08.github.io:3000/check-code', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      currentCode = code;
      document.getElementById('verify').style.display='none';
      document.getElementById('gacha').style.display='block';
      updateStatus();
    }else{
      alert(data.message);
    }
  });
}

// 扭蛋動畫 + 抽獎
function drawPrize(){
  const egg = document.getElementById('gachaEgg');
  egg.style.transform = 'rotate(360deg)'; // 旋轉動畫
  setTimeout(()=>{
    fetch('https://nny-08.github.io:3000/draw',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({code: currentCode})
    })
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        document.getElementById('gacha').style.display='none';
        document.getElementById('prizeImg').src = prizeImages[data.prize];
        document.getElementById('prizeName').innerText = data.prize;
        document.getElementById('prize').style.display='block';
        updateStatus();
        egg.style.transform = 'rotate(0deg)'; // 重置動畫
      }else{
        alert(data.message);
      }
    });
  },600); // 動畫時間
}

// 返回抽獎頁
function backToGacha(){
  document.getElementById('prize').style.display='none';
  document.getElementById('gacha').style.display='block';
}

  const express = require('express');
const cors = require('cors');
const app = express();
app.use(cors());
app.use(express.json());

// 模擬資料庫
let codes = []; // {code: '1234', used: false}
let draws = []; // {code: '1234', prize: 'A', timestamp: Date}
let totalDraws = 60;

// 獎項初始池 (總數依比例)
let prizePool = {
  A: Math.round(0.03 * totalDraws), // 3%
  B: Math.round(0.20 * totalDraws), // 20%
  C: Math.round(0.35 * totalDraws), // 35%
  D: Math.round(0.42 * totalDraws)  // 42%
};

// 生成4位隨機碼
function generateCode() {
  let code = '';
  for(let i=0;i<4;i++){
    code += Math.floor(Math.random()*10);
  }
  codes.push({code, used:false});
  return code;
}

// API: 生成驗證碼
app.get('/generate-code', (req,res)=>{
  const code = generateCode();
  res.json({code});
});

// API: 驗證驗證碼
app.post('/check-code', (req,res)=>{
  const { code } = req.body;
  const valid = codes.find(c => c.code === code && !c.used);
  if(valid){
    valid.used = true;
    res.json({success:true});
  } else {
    res.json({success:false, message:'驗證碼無效或已使用'});
  }
});

// API: 抽獎
app.post('/draw', (req,res)=>{
  const { code } = req.body;

  // 超過總抽獎次數
  const drawnTotal = draws.length;
  if(drawnTotal >= totalDraws) return res.json({success:false, message:'抽獎已滿60次'});

  // 製作剩餘獎項池
  const pool = [];
  for(let key in prizePool){
    for(let i=0;i<prizePool[key];i++){
      pool.push(key);
    }
  }

  // 隨機抽
  const randomIndex = Math.floor(Math.random()*pool.length);
  const prize = pool.splice(randomIndex,1)[0];
  prizePool[prize]--; // 減少剩餘
  draws.push({code, prize, timestamp:new Date()});

  res.json({success:true, prize});
});

// API: 查詢剩餘抽數
app.get('/status', (req,res)=>{
  const drawn = draws.length;
  const remaining = totalDraws - drawn;
  res.json({drawn, remaining});
});

// API: 後台查詢抽獎紀錄
app.get('/admin/draws', (req,res)=>{
  res.json(draws);
});

app.listen(3000, ()=>console.log('Server running on port 3000'));
</script>

</body>
</html>

